#!/usr/bin/with-contenv bashio
# ==============================================================================
# Run script for the Obsidian Home Assistant add-on
# ==============================================================================

# Declare variables from config.yaml
PUID=$(bashio::config 'PUID')
PGID=$(bashio::config 'PGID')
TZ=$(bashio::config 'TZ')

# Export environment variables
export PUID PGID TZ
bashio::log.info "Environment variables exported: PUID=$PUID, PGID=$PGID, TZ=$TZ"

# ==================================================================
# Setup folders
# ==================================================================

# addon_config folder
if [ ! -d /addon_config/obsidian ]; then
    bashio::log.info "Creating /addon_config/obsidian"
    mkdir -p /addon_config/obsidian
    chown -R "$PUID:$PGID" /addon_config/obsidian
fi
rm -rf /config
ln -s /addon_config/obsidian /config
bashio::log.info "Config folder linked"

# data folder for vault
if [ ! -d /data/obsidian ]; then
    bashio::log.info "Creating /data/obsidian"
    mkdir -p /data/obsidian
    chown -R "$PUID:$PGID" /data/obsidian
fi
rm -rf /vault
ln -s /data/obsidian /vault
bashio::log.info "Vault folder linked"

# ==================================================================
# Start Obsidian service
# ==================================================================
bashio::log.info "Starting Obsidian service..."
exec /usr/bin/obsidian
